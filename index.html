<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæœºè¯æ¡</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥è°·æ­Œå­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* å…¨å±€å­—ä½“ */
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #f3f4f6;
        }
        
        /* éšè—æ»šåŠ¨æ¡ */
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }

        /* å…¨å±å®¹å™¨ */
        .fullscreen-container {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        /* æ­¥éª¤ä¸‰çš„ç‰¹æ®Šå®¹å™¨ - ä¿æŒæµ…è‰²èƒŒæ™¯ */
        #single-display.fullscreen-container {
            background-color: #f8f9fa;
        }

        /* å€’è®¡æ—¶ç•Œé¢ä¿æŒæ·±è‰² */
        #countdown-display.fullscreen-container {
            background-color: #050505;
            color: white;
        }

        /* èƒŒæ™¯ç½‘æ ¼åŠ¨ç”» (ä»…æ·±è‰²æ¨¡å¼å¯è§) */
        .grid-bg {
            background-image: 
                linear-gradient(rgba(255, 0, 222, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 0, 222, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            position: absolute;
            inset: 0;
            z-index: 0;
        }

        @keyframes gridMove {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }

        /* æ¿€å…‰æ‰«æçº¿ */
        .laser-scan {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ffff, transparent);
            animation: laserScan 2s linear infinite;
            z-index: 1;
            opacity: 0.7;
            box-shadow: 0 0 10px #00ffff;
        }

        @keyframes laserScan {
            0% { top: 0; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* éœ“è™¹æŒ‰é’® (æ·±è‰²èƒŒæ™¯) */
        .neon-btn {
            background: transparent;
            border: 2px solid #ff00de;
            color: #ff00de;
            text-shadow: 0 0 5px #ff00de;
            box-shadow: 0 0 10px rgba(255, 0, 222, 0.3), inset 0 0 10px rgba(255, 0, 222, 0.1);
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }

        .neon-btn:hover {
            background: #ff00de;
            color: #0a0a0a;
            box-shadow: 0 0 20px #ff00de, 0 0 40px #ff00de;
            transform: scale(1.05);
        }

        /* å€’è®¡æ—¶æ•°å­—æ ·å¼ - æ·±è‰²èƒŒæ™¯ä¸“ç”¨ */
        .countdown-digit {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            color: #fff;
            text-shadow: 
                0 0 5px #fff,
                0 0 10px #fff,
                0 0 20px #00ffff,
                0 0 40px #00ffff;
            transition: all 0.3s ease;
        }

        /* æš‚åœçŠ¶æ€ä¸‹çš„å€’è®¡æ—¶ */
        .countdown-paused {
            color: #ff00de !important;
            text-shadow: 0 0 20px #ff00de !important;
            filter: grayscale(80%);
        }

        /* ç²’å­çˆ†ç‚¸åŠ¨ç”» */
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            animation: explode 1s ease-out forwards;
        }

        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--x), var(--y)) scale(0); opacity: 0; }
        }

        /* æ­¥éª¤2é€‰é¡¹éšæœºå‡ºç°åŠ¨ç”» */
        .random-item {
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.5s forwards;
        }

        @keyframes slideUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* å€’è®¡æ—¶ç»“æŸç‰¹æ•ˆ - å…¨å±é—ªçƒ */
        @keyframes finishFlash {
            0% { background-color: #050505; }
            10% { background-color: #ff00de; }
            20% { background-color: #050505; }
            30% { background-color: #00ffff; }
            40% { background-color: #050505; }
            100% { background-color: #050505; }
        }

        .finish-anim {
            animation: finishFlash 1.5s ease-out;
        }

        /* çˆ†ç‚¸æ–‡å­—æ•ˆæœ */
        .explode-text {
            animation: explodeTextAnim 1s ease-out forwards;
            position: absolute;
            white-space: nowrap;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes explodeTextAnim {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; filter: blur(0px); }
            100% { transform: translate(var(--tx), var(--ty)) scale(1.5); opacity: 0; filter: blur(5px); }
        }

        /* æ­¥éª¤ä¸‰çš„ç‰¹æ®Šæ ·å¼ */
        #single-word {
            color: #1a1a1a;
            font-weight: 900;
            letter-spacing: -0.05em;
        }
        
        /* æ­¥éª¤ä¸‰çš„æŒ‰é’®æ ·å¼ */
        #single-display .neon-btn {
            border-color: #333;
            color: #333;
            text-shadow: none;
            box-shadow: none;
        }
        #single-display .neon-btn:hover {
            background: #333;
            color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        /* æš‚åœæŒ‰é’®çš„ç‰¹å®šæ ·å¼ */
        .btn-pause {
            border-color: #fbbf24;
            color: #fbbf24;
            text-shadow: 0 0 5px #fbbf24;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
        .btn-pause:hover {
            background: #fbbf24;
            color: #000;
            box-shadow: 0 0 20px #fbbf24;
        }

        /* å¤šé€‰ä¸‹æ‹‰æ¡†æ ·å¼ä¼˜åŒ– */
        select[multiple] {
            background-image: none; /* ç§»é™¤é»˜è®¤ä¸‹æ‹‰ç®­å¤´ */
            padding-right: 1rem;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ (é’ˆå¯¹å¤šé€‰æ¡†) */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden relative z-10">
        
        <!-- æ­¥éª¤1: è¾“å…¥ç•Œé¢ -->
        <div id="step1" class="p-8 space-y-6">
            <h1 class="text-2xl font-bold text-center text-gray-800">âš™ï¸ è®¾ç½®è¯æ¡ä¸å€’è®¡æ—¶</h1>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    æ¯è¡Œè¾“å…¥ä¸€ä¸ªè¯æ¡ <span class="text-gray-400 text-xs">(å½“å‰è¯æ¡æ•°: <span id="term-count">0</span>)</span>
                </label>
                <textarea id="inputList" 
                    class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-none text-gray-600 bg-gray-50"
                    placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªè¯æ¡ï¼Œä¾‹å¦‚ï¼š&#10;è‹¹æœ&#10;é¦™è•‰&#10;æ©˜å­"></textarea>
            </div>

            <div class="flex items-center justify-center space-x-3">
                <label class="text-gray-700 font-medium">æŠ½å–æ•°é‡ (N):</label>
                <input type="number" id="nValue" value="3" min="1" 
                    class="w-20 p-2 text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold text-lg">
            </div>

            <!-- å€’è®¡æ—¶è®¾ç½® -->
            <div class="flex items-center justify-center space-x-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label class="text-gray-700 font-medium">å€’è®¡æ—¶:</label>
                <div class="flex space-x-1 items-center">
                    <input type="number" id="countdownHour" value="0" min="0" max="23"
                        class="w-14 p-2 text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono">
                    <span class="text-gray-500 font-bold">h</span>
                    <input type="number" id="countdownMinute" value="0" min="0" max="59"
                        class="w-14 p-2 text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono">
                    <span class="text-gray-500 font-bold">m</span>
                    <input type="number" id="countdownSecond" value="30" min="0" max="59"
                        class="w-14 p-2 text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono">
                    <span class="text-gray-500 font-bold">s</span>
                </div>
            </div>

            <!-- ä¿å­˜/åŠ è½½åŠŸèƒ½ -->
            <div class="flex flex-col space-y-2 pt-2 border-t border-gray-100">
                <!-- ä¿å­˜åŒºåŸŸ -->
                <div class="flex space-x-2">
                    <input type="text" id="saveName" 
                        class="flex-1 p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-blue-500"
                        placeholder="è¾“å…¥åç§°ä¿å­˜å½“å‰é…ç½®">
                    <button onclick="saveTerms()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow">
                        ä¿å­˜
                    </button>
                </div>
                
                <!-- åŠ è½½åŒºåŸŸ - å¤šé€‰ -->
                <div class="flex space-x-2 items-start">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 mb-1 block">é€‰æ‹©è¯åº“ (æŒ‰ä½ Ctrl/Cmd å¤šé€‰)</label>
                        <select id="loadSelect" multiple 
                            class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:border-blue-500 h-24 custom-scroll">
                            <!-- é€‰é¡¹å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="flex flex-col space-y-1 pt-5">
                        <button onclick="loadTerms()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium transition shadow">
                            åŠ è½½
                        </button>
                        <button onclick="deleteSelectedTerms()" 
                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition shadow">
                            åˆ é™¤
                        </button>
                    </div>
                </div>
            </div>

            <button onclick="goToStep2()" 
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg transform hover:-translate-y-0.5">
                ğŸ² å¼€å§‹éšæœºæŠ½å–
            </button>
            <div id="step1-error" class="text-red-500 text-sm text-center hidden font-medium"></div>
        </div>

        <!-- æ­¥éª¤2: éšæœºå±•ç¤ºnä¸ªé€‰é¡¹ -->
        <div id="step2" class="p-8 space-y-6 hidden">
            <h2 class="text-xl font-bold text-center text-gray-800">
                è¯·ä»ä»¥ä¸‹ <span id="n-display" class="text-blue-600 text-2xl">3</span> ä¸ªé€‰é¡¹ä¸­é€‰æ‹©ä¸€ä¸ªï¼š
            </h2>
            
            <div id="random-container" class="flex flex-col space-y-3 w-full min-h-[200px] justify-center">
                <!-- JSåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="flex flex-col space-y-3 mt-6">
                <button onclick="goToStep2()" 
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition shadow">
                    ğŸ”„ å†è¯•ä¸€æ¬¡ (é‡æ–°éšæœº)
                </button>
                <button onclick="goToStep1()" 
                    class="w-full border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-3 px-4 rounded-lg transition">
                    â† è¿”å›é‡æ–°è®¾ç½®
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤3: å…¨å±å±•ç¤ºå•ä¸ªè¯ -->
        <div id="single-display" class="fullscreen-container hidden">
            <button onclick="goBackToStep2()" 
                class="absolute top-6 left-6 bg-white/80 hover:bg-white text-gray-600 px-4 py-2 rounded-lg font-medium transition shadow border border-gray-200 backdrop-blur-sm">
                â† è¿”å›é€‰é¡¹
            </button>

            <div class="flex-1 flex items-center justify-center w-full px-8 py-12">
                <div id="single-word" 
                    class="text-center font-bold 
                           flex flex-wrap justify-center items-center
                           text-6xl md:text-8xl lg:text-9xl 
                           leading-none max-w-full break-words word-display transition-all duration-300">
                    <!-- è¯ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <div class="fixed bottom-8 left-0 right-0 flex justify-center space-x-4">
                <button onclick="goBackToStep2()" 
                    class="bg-white hover:bg-gray-100 text-gray-700 font-semibold py-3 px-6 rounded-lg transition shadow-md border border-gray-200">
                    è¿”å›é€‰å•
                </button>
                <button onclick="goToStep1()" 
                    class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md">
                    ç»“æŸ/é‡ç½®
                </button>
                <!-- å€’è®¡æ—¶æŒ‰é’® -->
                <button onclick="startCountdown()" 
                    class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md flex items-center space-x-2">
                    <span>â±ï¸</span> <span>å¼€å§‹å€’è®¡æ—¶</span>
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤4: å€’è®¡æ—¶ç•Œé¢ -->
        <div id="countdown-display" class="fullscreen-container hidden">
            <!-- èƒŒæ™¯ä¸ç‰¹æ•ˆ -->
            <div class="grid-bg"></div>
            <div class="laser-scan"></div>
            <div class="particle-container absolute inset-0 overflow-hidden pointer-events-none z-20" id="particle-container"></div>

            <!-- **ç§»é™¤äº†è¯æ¡é¢„è§ˆ** -->

            <div class="flex-1 flex flex-col items-center justify-center w-full px-8 py-12 relative z-10">
                <!-- å€’è®¡æ—¶æ•°å­— -->
                <div id="countdown-number" 
                    class="text-center font-bold 
                           text-6xl md:text-8xl lg:text-[10rem] 
                           countdown-digit select-none cursor-pointer"
                           onclick="togglePause()">
                    <!-- å€’è®¡æ—¶æ•°å­—ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <div class="text-gray-400 mt-4 text-lg font-mono tracking-widest opacity-60">ç‚¹å‡»æ•°å­—å¯æš‚åœ</div>
            </div>

            <div class="fixed bottom-8 left-0 right-0 flex justify-center space-x-4 relative z-30">
                <button id="btn-pause" onclick="togglePause()" 
                    class="neon-btn btn-pause px-6 py-3 rounded-lg font-bold text-lg tracking-wider">
                    æš‚åœ (Pause)
                </button>
                <button onclick="cancelCountdown()" 
                    class="neon-btn px-6 py-3 rounded-lg font-bold text-lg tracking-wider">
                    å–æ¶ˆ
                </button>
            </div>
        </div>

    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let state = {
            n: 3,
            countdown: 30, // é»˜è®¤30ç§’
            terms: [],
            randomSelection: [],
            selectedTerm: null,
            countdownInterval: null,
            isCountingDown: false,
            isPaused: false,
            remainingTime: 0
        };

        // --- å¯¼èˆªæ§åˆ¶ ---

        function showStep(stepNum) {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('single-display').classList.add('hidden');
            document.getElementById('countdown-display').classList.add('hidden');

            if (stepNum === 1) document.getElementById('step1').classList.remove('hidden');
            else if (stepNum === 2) document.getElementById('step2').classList.remove('hidden');
            else if (stepNum === 3) document.getElementById('single-display').classList.remove('hidden');
            else if (stepNum === 4) document.getElementById('countdown-display').classList.remove('hidden');
        }

        function goToStep1() {
            stopCountdown();
            showStep(1);
            state.randomSelection = [];
            state.selectedTerm = null;
            updateTermCount();
        }

        function goToStep2() {
            const rawText = document.getElementById('inputList').value;
            const nInput = document.getElementById('nValue').value;
            const errorMsg = document.getElementById('step1-error');
            
            state.terms = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            state.n = parseInt(nInput);

            if (state.terms.length === 0) {
                showError("è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªè¯æ¡ï¼");
                return;
            }
            if (state.n <= 0 || state.n > state.terms.length) {
                showError(`Nå€¼å¿…é¡»åœ¨ 1 åˆ° ${state.terms.length} ä¹‹é—´`);
                return;
            }
            errorMsg.classList.add('hidden');

            performRandomSelection();
            document.getElementById('n-display').textContent = state.n;
            renderRandomGrid();
            showStep(2);
        }

        function goToStep3(term) {
            state.selectedTerm = term;
            document.getElementById('single-word').textContent = term;
            showStep(3);
        }

        function goBackToStep2() {
            stopCountdown();
            showStep(2);
        }

        function showError(msg) {
            const errorMsg = document.getElementById('step1-error');
            errorMsg.textContent = msg;
            errorMsg.classList.remove('hidden');
        }

        // --- é€»è¾‘å‡½æ•° ---

        function performRandomSelection() {
            let tempArray = [...state.terms];
            // æ´—ç‰Œç®—æ³•
            for (let i = tempArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tempArray[i], tempArray[j]] = [tempArray[j], tempArray[i]];
            }
            state.randomSelection = tempArray.slice(0, state.n);
        }

        function renderRandomGrid() {
            const container = document.getElementById('random-container');
            container.innerHTML = '';
            
            if (state.randomSelection.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">æ²¡æœ‰ç”Ÿæˆé€‰é¡¹ï¼Œè¯·æ£€æŸ¥è¾“å…¥</div>';
                return;
            }

            state.randomSelection.forEach((term, index) => {
                const div = document.createElement('div');
                div.className = "random-item w-full bg-white border-2 border-gray-200 rounded-xl py-4 px-6 text-center text-lg font-bold text-gray-700 hover:bg-blue-50 hover:border-blue-400 hover:text-blue-700 transition-all cursor-pointer shadow-sm hover:shadow-md transform hover:-translate-x-1";
                div.style.animationDelay = `${index * 0.1}s`;
                div.textContent = term;
                div.onclick = () => goToStep3(term);
                container.appendChild(div);
            });
        }

        // --- å€’è®¡æ—¶æ ¸å¿ƒé€»è¾‘ ---

        function setCountdownFromInputs() {
            const hour = parseInt(document.getElementById('countdownHour').value) || 0;
            const minute = parseInt(document.getElementById('countdownMinute').value) || 0;
            const second = parseInt(document.getElementById('countdownSecond').value) || 0;
            state.countdown = hour * 3600 + minute * 60 + second;
        }

        function updateCountdownInputs() {
            let totalSeconds = state.countdown;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            document.getElementById('countdownHour').value = hours;
            document.getElementById('countdownMinute').value = minutes;
            document.getElementById('countdownSecond').value = seconds;
        }

        function startCountdown() {
            if (state.isCountingDown && !state.isPaused) return;
            
            if (state.isPaused) {
                togglePause();
                return;
            }

            setCountdownFromInputs();
            if (state.countdown <= 0) {
                alert("å€’è®¡æ—¶æ—¶é—´å¿…é¡»å¤§äº0");
                return;
            }

            showStep(4);
            // **ä¸å†æ˜¾ç¤ºè¯æ¡**
            
            state.remainingTime = state.countdown;
            state.isCountingDown = true;
            state.isPaused = false;
            
            updatePauseBtnUI();
            updateCountdownDisplay(state.remainingTime);

            if (state.countdownInterval) clearInterval(state.countdownInterval);

            state.countdownInterval = setInterval(() => {
                if (!state.isPaused) {
                    state.remainingTime--;
                    updateCountdownDisplay(state.remainingTime);

                    if (state.remainingTime <= 0) {
                        finishCountdown();
                    }
                }
            }, 1000);
        }

        function togglePause() {
            if (!state.isCountingDown) return;

            state.isPaused = !state.isPaused;
            updatePauseBtnUI();

            const numElement = document.getElementById('countdown-number');
            if (state.isPaused) {
                numElement.classList.add('countdown-paused');
            } else {
                numElement.classList.remove('countdown-paused');
            }
        }

        function updatePauseBtnUI() {
            const btn = document.getElementById('btn-pause');
            const numElement = document.getElementById('countdown-number');
            
            if (state.isPaused) {
                btn.textContent = "ç»§ç»­ (Resume)";
                btn.classList.add('bg-yellow-600/20');
                numElement.style.opacity = '0.5';
                numElement.style.transform = 'scale(0.95)';
            } else {
                btn.textContent = "æš‚åœ (Pause)";
                btn.classList.remove('bg-yellow-600/20');
                numElement.style.opacity = '1';
                numElement.style.transform = 'scale(1)';
            }
        }

        function updateCountdownDisplay(time) {
            const numElement = document.getElementById('countdown-number');
            const formattedTime = formatTime(time);
            numElement.textContent = formattedTime;

            // æœ€å10ç§’è§†è§‰è­¦å‘Š
            if (time <= 10 && time > 0) {
                numElement.style.color = '#ff3333';
                numElement.style.textShadow = '0 0 20px #ff0000, 0 0 40px #ff0000';
                // éœ‡åŠ¨æ•ˆæœ (å¦‚æœæ”¯æŒ)
                if (navigator.vibrate) navigator.vibrate(50);
                // äº§ç”Ÿç²’å­
                createParticles();
            } else if (time > 10) {
                numElement.style.color = '#fff';
                numElement.style.textShadow = '';
            }

            // æ•°å­—å˜åŒ–æ—¶çš„å¾®å°è„‰å†²
            if (time > 0 && !state.isPaused) {
                numElement.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    if(!state.isPaused) numElement.style.transform = 'scale(1)';
                }, 150);
            }
        }

        function finishCountdown() {
            clearInterval(state.countdownInterval);
            state.isCountingDown = false;
            state.isPaused = false;

            const numElement = document.getElementById('countdown-number');
            const container = document.getElementById('countdown-display');
            
            // 1. å…¨å±é—ªçƒç‰¹æ•ˆ
            container.classList.add('finish-anim');

            // 2. çˆ†ç‚¸æ–‡å­—ç‰¹æ•ˆ
            triggerExplosionText();

            // 3. æ•°å­—å½’é›¶å¹¶æ”¾å¤§
            numElement.textContent = "00:00:00";
            numElement.style.transform = "scale(1.5)";
            numElement.style.color = "#ff00de";
            numElement.style.textShadow = "0 0 50px #ff00de, 0 0 100px #ff00de";

            // 4. 2ç§’åè¿”å›è¯æ¡ç•Œé¢ (æ­¥éª¤3)
            setTimeout(() => {
                container.classList.remove('finish-anim');
                numElement.style.transform = "";
                showStep(3);
                // è§¦å‘æ­¥éª¤3çš„ç»“æŸç‰¹æ•ˆ
                triggerFinishEffect();
            }, 2000);
        }

        function cancelCountdown() {
            stopCountdown();
            showStep(3);
        }

        function stopCountdown() {
            if (state.countdownInterval) {
                clearInterval(state.countdownInterval);
                state.countdownInterval = null;
            }
            state.isCountingDown = false;
            state.isPaused = false;
            state.remainingTime = 0;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600)  / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // --- ç‰¹æ•ˆå‡½æ•° ---

        function createParticles() {
            const container = document.getElementById('particle-container');
            if (!container) return;
            
            const rect = container.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;

            for (let i = 0; i < 3; i++) { // æ¯æ¬¡äº§ç”Ÿ3ä¸ªç²’å­
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                
                const angle = Math.random() * Math.PI * 2;
                const distance = 50 + Math.random() * 150;
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance;
                
                particle.style.setProperty('--x', `${x}px`);
                particle.style.setProperty('--y', `${y}px`);
                particle.style.background = ['#ff00de', '#00ffff', '#ffffff'][Math.floor(Math.random() * 3)];
                
                container.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
        }

        function triggerExplosionText() {
            const container = document.getElementById('countdown-display');
            const text = "TIME UP!";
            
            for (let i = 0; i < 12; i++) {
                const span = document.createElement('span');
                span.textContent = text;
                span.className = 'explode-text text-4xl font-bold text-white';
                
                const angle = (i / 12) * Math.PI * 2;
                const distance = 100 + Math.random() * 100;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                const startX = 50 + (Math.random() - 0.5) * 0.2;
                const startY = 50 + (Math.random() - 0.2) * 0.2;

                span.style.left = `${startX}%`;
                span.style.top = `${startY}%`;
                span.style.setProperty('--tx', `${tx}px`);
                span.style.setProperty('--ty', `${ty}px`);
                
                container.appendChild(span);
                setTimeout(() => span.remove(), 1000);
            }
        }

        function triggerFinishEffect() {
            const wordElement = document.getElementById('single-word');
            if (wordElement) {
                wordElement.classList.add('finish-anim');
                setTimeout(() => wordElement.classList.remove('finish-anim'), 1500);
            }
        }

        // --- ä¿å­˜/åŠ è½½åŠŸèƒ½ (å¤šè¯åº“æ”¯æŒ) ---

        function saveTerms() {
            const name = document.getElementById('saveName').value.trim();
            const rawText = document.getElementById('inputList').value.trim();
            
            if (!name || !rawText) {
                alert('è¯·è¾“å…¥åç§°å’Œè¯æ¡ï¼');
                return;
            }

            setCountdownFromInputs();

            // ä¿®æ­£é”®åï¼šä¹‹å‰çš„ä»£ç å¯èƒ½æœ‰ç¬”è¯¯ '0savedTerms'
            let savedTerms = JSON.parse(localStorage.getItem('savedTerms') || '{}');
            
            if (savedTerms[name] && !confirm(`"${name}" å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
                return;
            }

            savedTerms[name] = {
                terms: rawText,
                n: document.getElementById('nValue').value,
                countdown: state.countdown,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('savedTerms', JSON.stringify(savedTerms));
            
            document.getElementById('saveName').value = '';
            updateLoadSelect();
            alert(`"${name}" å·²ä¿å­˜ï¼`);
        }

        function loadTerms() {
            const select = document.getElementById('loadSelect');
            // è·å–æ‰€æœ‰é€‰ä¸­çš„é€‰é¡¹
            const selectedOptions = Array.from(select.selectedOptions);
            
            if (selectedOptions.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè¯åº“ï¼');
                return;
            }

            let mergedTerms = [];
            let nValue = null;
            let countdownValue = null;

            // éå†é€‰ä¸­çš„æ¯ä¸€ä¸ªè¯åº“
            selectedOptions.forEach(option => {
                const name = option.value;
                const savedTerms = JSON.parse(localStorage.getItem('savedTerms') || '{}');
                const data = savedTerms[name];
                
                if (data) {
                    // åˆå¹¶è¯æ¡
                    const termsArray = data.terms.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                    mergedTerms = mergedTerms.concat(termsArray);
                    
                    // ä¼˜å…ˆä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰ä¸­çš„è¯åº“çš„Nå€¼å’Œå€’è®¡æ—¶è®¾ç½®
                    if (nValue === null) nValue = data.n;
                    if (countdownValue === null) countdownValue = data.countdown;
                }
            });

            // å»é‡ (å¯é€‰ï¼Œå¦‚æœå¸Œæœ›ä¿ç•™é‡å¤é¡¹å¯ä»¥å»æ‰è¿™è¡Œ)
            // mergedTerms = [...new Set(mergedTerms)];

            // æ›´æ–°UIå’ŒçŠ¶æ€
            document.getElementById('inputList').value = mergedTerms.join('\n');
            document.getElementById('nValue').value = nValue || 3;
            state.countdown = countdownValue || 30;
            updateCountdownInputs();
            updateTermCount();

            // æç¤ºç”¨æˆ·
            const names = selectedOptions.map(o => o.value).join('ã€');
            alert(`å·²åˆå¹¶åŠ è½½ ${selectedOptions.length} ä¸ªè¯åº“ï¼š${names}`);
        }

        function deleteSelectedTerms() {
            const select = document.getElementById('loadSelect');
            const selectedOptions = Array.from(select.selectedOptions);
            
            if (selectedOptions.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¯åº“ï¼');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedOptions.length} ä¸ªè¯åº“å—ï¼Ÿ`)) {
                return;
            }

            const savedTerms = JSON.parse(localStorage.getItem('savedTerms') || '{}');
            
            selectedOptions.forEach(option => {
                delete savedTerms[option.value];
            });

            localStorage.setItem('savedTerms', JSON.stringify(savedTerms));
            updateLoadSelect();
            alert('åˆ é™¤æˆåŠŸï¼');
        }

        function updateLoadSelect() {
            const select = document.getElementById('loadSelect');
            // ä¿®æ­£é”®å
            const savedTerms = JSON.parse(localStorage.getItem('savedTerms') || '{}');
            
            select.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹

            // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
            const sortedNames = Object.keys(savedTerms).sort((a, b) => {
                return new Date(savedTerms[b].timestamp) - new Date(savedTerms[a].timestamp);
            });

            sortedNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${savedTerms[name].terms.split('\n').length}ä¸ªè¯)`;
                select.appendChild(option);
            });
        }

        function updateTermCount() {
            const rawText = document.getElementById('inputList').value;
            const count = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 0).length;
            document.getElementById('term-count').textContent = count;
        }

        // åˆå§‹åŒ–
        document.getElementById('inputList').addEventListener('input', updateTermCount);
        window.onload = function() {
            updateLoadSelect();
            updateTermCount();
        };
    </script>
</body>
</html>
